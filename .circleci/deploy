#!/bin/bash
set -e

IMAGE=$1
REPOSITORY=${IMAGE%:*}
TAG=${IMAGE#*:}
IMAGE_COMMIT_TAG=cache-$CIRCLE_SHA1-$TAG

# Do nothing if this wasn't rebuilt.
image_exists $REPOSITORY $IMAGE_COMMIT_TAG || { echo "No new image found." && exit 0; }

deploy_ecr $1
deploy_terraform
deploy_service $REPOSITORY