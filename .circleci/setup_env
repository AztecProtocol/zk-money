#!/bin/bash
set -e

[ -n "$CIRCLE_TOKEN" ] || (echo "No CIRCLE_TOKEN available." && exit 1)

BUILD_SYSTEM_PATH=$(pwd)/.circleci

echo export BUILD_SYSTEM_PATH=$BUILD_SYSTEM_PATH >> $BASH_ENV
echo export SSH_CONFIG_PATH=$BUILD_SYSTEM_PATH/remote/ssh_config >> $BASH_ENV
echo export PATH=$PATH:$BUILD_SYSTEM_PATH >> $BASH_ENV
echo export AWS_DEFAULT_REGION=eu-west-2 >> $BASH_ENV
echo export ECR_REGION=us-east-2 >> $BASH_ENV
echo export ECR_URL=278380418400.dkr.ecr.us-east-2.amazonaws.com >> $BASH_ENV
echo export ECR_DEPLOY_REGION=eu-west-2 >> $BASH_ENV
echo export ECR_DEPLOY_URL=278380418400.dkr.ecr.eu-west-2.amazonaws.com >> $BASH_ENV
echo export REBUILD=$1 >> $BASH_ENV
echo export TF_VAR_IMAGE_TAG=$CIRCLE_TAG >> $BASH_ENV
echo export CIRCLE_BRANCH=$CIRCLE_BRANCH >> $BASH_ENV
cat $BASH_ENV

# Ensure correct permissions on build instance key.
cp .circleci/remote/build_instance_key ~/.ssh/build_instance_key
chmod 600 ~/.ssh/build_instance_key