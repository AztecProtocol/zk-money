#!/bin/bash
# Succeeds if any files matching the rebuild patterns, have changed since the base commit.
set -e

# If rebuild is forced.
if [ "$REBUILD" == "true" ]; then
  echo "Forced rebuild requested."
  exit 0
fi

# If this is a tagged commit, rebuild.
if [ -n "$CIRCLE_TAG" ]; then
  echo "Rebuilding tagged commit."
  exit 0
fi

BASE_COMMIT=$1
PATTERNS=${2:-.rebuild_patterns}

# If given nothing, then return true to rebuild.
[ -n "$BASE_COMMIT" ] || exit 0

# If there are is no rebuild patterns file, create one from project directory.
if [ ! -f "$PATTERNS" ]; then
  echo "^$(git rev-parse --show-prefix)" > $PATTERNS
fi

if git diff --name-only ${BASE_COMMIT} ${CIRCLE_SHA1} | grep -q -f $PATTERNS; then
  exit 0
else
  exit 1
fi