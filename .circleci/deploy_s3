#!/bin/bash
set -e

REPOSITORY=$1
TF_DIR=${2:-./terraform}

if [ ! -d $TF_DIR ]; then
   echo "No terraform dir at $TF_DIR. Required for bucket and cloudfront outputs."
   exit 1
fi

extract_repo $REPOSITORY /usr/src/$REPOSITORY/dist ./dist

deploy_terraform $TF_DIR

pushd $TF_DIR > /dev/null
AWS_BUCKET_NAME=$(terraform output s3)
AWS_CLOUDFRONT_DISTRIBUTION=$(terraform output cloudfront)
popd > /dev/null

aws s3 rm s3://$AWS_BUCKET_NAME --recursive
aws s3 cp ./dist s3://$AWS_BUCKET_NAME --recursive --metadata-directive REPLACE --cache-control "no-cache" --acl public-read
aws s3 cp \
       s3://$AWS_BUCKET_NAME \
       s3://$AWS_BUCKET_NAME \
       --exclude '*' \
       --include '*.js' \
       --no-guess-mime-type \
       --content-type="application/javascript; charset=utf-8" \
       --metadata-directive="REPLACE" \
       --cache-control "no-cache" \
       --recursive
aws cloudfront create-invalidation --distribution-id $AWS_CLOUDFRONT_DISTRIBUTION --paths "/*"
